<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Круговой Таймер-Будильник 24h</title>
    <style>
        /* === ОБЩИЕ СТИЛИ === */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #1a1a1a;
            color: #fff;
            margin: 0;
            flex-direction: column;
        }
        .container {
            background: #2c2c2c;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            max-width: 450px;
            width: 90%;
            text-align: center;
        }
        h1 {
            color: #76c7c0;
            margin-bottom: 25px;
        }

        /* === СТИЛИ КОЛЕСА ВЫБОРА ВРЕМЕНИ === */
        .time-picker {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
        }
        .time-picker-column {
            /* Высота, имитирующая "окно" выбора */
            height: 180px;
            width: 80px;
            overflow-y: scroll;
            border-radius: 8px;
            position: relative;
            /* Включение привязки прокрутки для эффекта "защелкивания" */
            scroll-snap-type: y mandatory;
            background-color: #3a3a3a;
            scrollbar-width: none; /* Скрытие скроллбара для Firefox */
            -ms-overflow-style: none; /* Скрытие скроллбара для IE/Edge */
        }
        /* Скрытие скроллбара для Chrome, Safari, Opera */
        .time-picker-column::-webkit-scrollbar {
            display: none;
        }

        .time-picker-item {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px; /* Высота одного элемента (окно = 3 элемента) */
            font-size: 32px;
            font-weight: 500;
            color: #888;
            /* Привязка прокрутки к центру элемента */
            scroll-snap-align: center;
            transition: color 0.2s, transform 0.2s;
        }

        /* Дополнительные пустые элементы для центрирования выбора */
        .time-picker-column::before,
        .time-picker-column::after {
            content: "";
            display: block;
            height: 60px; /* Половина высоты окна минус высота элемента */
        }

        /* Разделитель ":" */
        .separator {
            font-size: 32px;
            color: #76c7c0;
            margin: 0 5px;
            line-height: 60px;
            height: 60px;
        }

        /* === СТИЛИ КНОПОК И СООБЩЕНИЙ === */
        button {
            padding: 12px 25px;
            font-size: 18px;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            transition: background-color 0.3s;
            margin: 5px;
            font-weight: bold;
        }
        #setButton {
            background-color: #76c7c0;
            color: #1a1a1a;
        }
        #setButton:hover {
            background-color: #5fb1ab;
        }
        #stopButton {
            background-color: #dc3545;
            color: white;
            display: none;
        }
        #stopButton:hover {
            background-color: #c82333;
        }
        #message {
            margin-top: 25px;
            font-size: 18px;
            min-height: 25px;
            color: #a0ff80;
        }
        .alarm-sound {
            display: none;
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>⏰ Установите Будильник (24ч)</h1>

        <div class="time-picker">
            <div id="hoursColumn" class="time-picker-column">
                </div>
            <div class="separator">:</div>
            <div id="minutesColumn" class="time-picker-column">
                </div>
        </div>

        <button id="setButton" onclick="setAlarm()">Установить Таймер</button>
        <button id="stopButton" onclick="stopAlarm()">Остановить</button>

        <div id="message"></div>

        <audio id="alarmSound" class="alarm-sound" loop>
            <source src="https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3" type="audio/mpeg">
        </audio>
    </div>

    <script>
        const HOURS_COLUMN = document.getElementById('hoursColumn');
        const MINUTES_COLUMN = document.getElementById('minutesColumn');
        const ALARM_SOUND = document.getElementById('alarmSound');
        const MESSAGE_DISPLAY = document.getElementById('message');
        const SET_BUTTON = document.getElementById('setButton');
        const STOP_BUTTON = document.getElementById('stopButton');
        const ITEM_HEIGHT = 60; // Должно соответствовать .time-picker-item height в CSS

        let alarmInterval;

        // Функция для форматирования числа (добавление ведущего нуля)
        const formatTime = (value) => value.toString().padStart(2, '0');

        // === 1. ЗАПОЛНЕНИЕ КОЛОНОК (КОЛЕС) ===
        function populateColumns() {
            // Часы (00 до 23)
            for (let i = 0; i < 24; i++) {
                const div = document.createElement('div');
                div.className = 'time-picker-item';
                div.textContent = formatTime(i);
                HOURS_COLUMN.appendChild(div);
            }

            // Минуты (00 до 59)
            for (let i = 0; i < 60; i++) {
                const div = document.createElement('div');
                div.className = 'time-picker-item';
                div.textContent = formatTime(i);
                MINUTES_COLUMN.appendChild(div);
            }

            // Установка текущего времени по умолчанию (с прокруткой)
            const now = new Date();
            scrollToItem(HOURS_COLUMN, now.getHours());
            scrollToItem(MINUTES_COLUMN, now.getMinutes());

            // Добавление слушателей прокрутки для "захвата" выбранного значения
            HOURS_COLUMN.addEventListener('scroll', handleScrollEnd);
            MINUTES_COLUMN.addEventListener('scroll', handleScrollEnd);
        }

        // Прокрутка к элементу по индексу
        function scrollToItem(column, index) {
            column.scrollTop = index * ITEM_HEIGHT;
        }

        // Функция для задержки обработки прокрутки, чтобы дождаться остановки
        let scrollTimeout;
        function handleScrollEnd(event) {
            const column = event.target;
            clearTimeout(scrollTimeout);

            // Устанавливаем таймаут, чтобы подождать, пока прокрутка полностью остановится (из-за scroll-snap)
            scrollTimeout = setTimeout(() => {
                // Вычисляем индекс выбранного элемента в центре "окна"
                const selectedIndex = Math.round(column.scrollTop / ITEM_HEIGHT);

                // Прокручиваем к ближайшему "защелкнутому" элементу, чтобы убедиться в его центрировании
                column.scrollTop = selectedIndex * ITEM_HEIGHT;

                // Опционально: можно добавить подсветку для активного элемента
                // const items = column.querySelectorAll('.time-picker-item');
                // items.forEach((item, index) => {
                //     item.style.color = index === selectedIndex ? '#fff' : '#888';
                // });
            }, 100); // Небольшая задержка
        }

        // === 2. ЛОГИКА ТАЙМЕРА ===

        // Получение выбранного часа/минуты из центральной позиции колеса
        function getSelectedTime(column) {
            const selectedIndex = Math.round(column.scrollTop / ITEM_HEIGHT);
            // Возвращаем числовое значение (0-23 или 0-59)
            return selectedIndex;
        }

        function setAlarm() {
            // Получаем выбранные значения
            const selectedHour = getSelectedTime(HOURS_COLUMN);
            const selectedMinute = getSelectedTime(MINUTES_COLUMN);
            const alarmTimeString = `${formatTime(selectedHour)}:${formatTime(selectedMinute)}`;

            // Создаем целевую дату
            const now = new Date();
            let alarmTarget = new Date(now.getFullYear(), now.getMonth(), now.getDate(), selectedHour, selectedMinute, 0);

            // Если время уже прошло сегодня, устанавливаем на завтра
            if (alarmTarget.getTime() <= now.getTime()) {
                alarmTarget.setDate(alarmTarget.getDate() + 1);
            }

            // Обновление интерфейса и запуск интервала
            stopAlarm(false); // Сбросить предыдущий таймер без сброса интерфейса
            HOURS_COLUMN.style.pointerEvents = 'none'; // Блокировка выбора
            MINUTES_COLUMN.style.pointerEvents = 'none';
            SET_BUTTON.disabled = true;
            STOP_BUTTON.style.display = 'inline-block';

            // Запускаем проверку каждую секунду
            alarmInterval = setInterval(() => {
                const currentTime = new Date().getTime();

                if (currentTime >= alarmTarget.getTime()) {
                    triggerAlarm(alarmTimeString);
                } else {
                    const remaining = alarmTarget.getTime() - currentTime;
                    const h = Math.floor(remaining / (1000 * 60 * 60));
                    const m = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    const s = Math.floor((remaining % (1000 * 60)) / 1000);

                    MESSAGE_DISPLAY.textContent = `До звонка в ${alarmTimeString} осталось: ${h}ч ${m}мин ${s}сек`;
                }
            }, 1000);
            sendToServer(alarmTimeString);
        }

        function triggerAlarm(time) {
            clearInterval(alarmInterval);
            ALARM_SOUND.play();
            MESSAGE_DISPLAY.textContent = `🚨 БУДИЛЬНИК! Время ${time}!`;

            // Отправляем на сервер, чтобы Python-бот сработал
            fetch("http://127.0.0.1:5000/send_message", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({text: `⏰ Будильник! Время ${time}`})
            })
            .then(res => res.json())
            .then(data => console.log("Ответ сервера:", data))
            .catch(err => console.error("Ошибка при отправке на сервер:", err));
        }

        function sendToServer(timeString) {
            fetch("http://localhost:5000/set_alarm", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ time: timeString })
            })
            .then(res => res.json())
            .then(data => console.log(data))
            .catch(err => console.error("Ошибка связи с сервером:", err));
        }

        function stopAlarm(reset = true) {
            if (alarmInterval) {
                clearInterval(alarmInterval);
            }
            ALARM_SOUND.pause();
            ALARM_SOUND.currentTime = 0;

            if (reset) {
                MESSAGE_DISPLAY.textContent = 'Таймер остановлен. Установите новое время.';
                HOURS_COLUMN.style.pointerEvents = 'auto'; // Разблокировка выбора
                MINUTES_COLUMN.style.pointerEvents = 'auto';
                SET_BUTTON.disabled = false;
                STOP_BUTTON.style.display = 'none';
            }
        }

        // Инициализация при загрузке страницы
        window.onload = populateColumns;
    </script>

</body>
</html>
